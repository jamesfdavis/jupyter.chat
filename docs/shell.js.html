<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: shell.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: shell.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as fs from 'fs';
import * as readline from 'readline';
import { Duplex } from 'stream';
import * as chalk from 'chalk';
import cline from 'cline'
import * as log from 'log'
import * as  _require from './message.js';
import { Adapter } from './adapter.js'

const TextMessage = _require.TextMessage
const historySize = 1024
const historyPath = '.shell_history'

/** Shell Adapter concrete class. */
class Shell extends Adapter {

  CommandLine;
  Logger;

  /**
  * Send a message
  * @param {Envelope} envelope - Send a message.
  */
  send(envelope) {
    const strings = [].slice.call(arguments, 1)
    Array.from(strings).forEach(str => console.Logger(chalk.bold(`${str}`)))
  }

  /**
  * Reply to a message
  * @param {Envelope} envelope - Send a reply
  */
  reply(envelope) {
    // const strings = [].slice.call(arguments, 1).map((s) => `${s}`)
    // this.send.apply(this, [envelope].concat(strings))
  }

  /**
  * Run the interface and load history.
  */
  run() {
    this.buildCli();

    loadHistory((error, history) => {
      if (error) {
        console.Logger(error.message);
      } else {
        this.CommandLine.history(history);

      }
      this.CommandLine.interact(`${this.robot.name}> `);
      return this.emit('connected');
    })
  }

  /**
   * Shutdown the Shell
   */
  shutdown() {
    this.robot.shutdown();
    return process.exit(0);
  }

  /**
   * Build and the interface
   */
  buildCli() {
    this.CommandLine = cline();

    this.CommandLine.command('*', input => {
      const userName = process.env.JUPYTER_SHELL_USER_NAME || 'Shell'
      let user = { name: "User", room: "Shell" }
      this.receive(new TextMessage(user, input, 'messageId'))
    })

    this.CommandLine.command('history', () => {
      Array.from(this.CommandLine.history()).map(item => console.Logger(item))
    })

    this.CommandLine.on('history', (item) => {
      if (item.length > 0 &amp;&amp; item !== 'exit' &amp;&amp; item !== 'history') {
        fs.appendFile(historyPath, `${item}\n`, error => {
          if (error) {
            this.robot.emit('error', error)
          }
        })
      }
    })

    this.CommandLine.on('close', () => {
      let fileOpts, history, i, item, len, outstream, startIndex

      history = this.CommandLine.history()

      if (history.length &lt;= historySize) {
        return this.shutdown()
      }

      startIndex = history.length - historySize
      history = history.reverse().splice(startIndex, historySize)
      fileOpts = {
        mode: 0x180
      }

      outstream = fs.createWriteStream(historyPath, fileOpts)
      outstream.on('finish', this.shutdown.bind(this))

      for (i = 0, len = history.length; i &lt; len; i++) {
        item = history[i]
        outstream.write(item + '\n')
      }

      outstream.end(this.shutdown.bind(this));
    })
  }
}

/**
 * Load history from .shell_history.
 * @param  {} callback A Function that is called with the loaded history items (or an empty array if there is no history)
 */
function loadHistory(callback) {
  if (!fs.existsSync(historyPath)) {
    return callback(new Error('No history available'))
  }

  const instream = fs.createReadStream(historyPath)
  const outstream = new Duplex();
  const items = []

  readline.createInterface({ input: instream, output: outstream, terminal: false })
    .on('line', function (line) {
      line = line.trim()
      if (line.length > 0) {
        items.push(line)
      }
    })
    .on('close', () => callback(null, items))
    .on('error', callback)
}

/**
 * @param  {} robot Robot instance
 * @return  {} new Shell Adapter
 */
function create(robot) {
  return new Shell(robot)
}

export { create as default }
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Adapter.html">Adapter</a></li><li><a href="CatchAllMessage.html">CatchAllMessage</a></li><li><a href="EnterMessage.html">EnterMessage</a></li><li><a href="LeaveMessage.html">LeaveMessage</a></li><li><a href="Message.html">Message</a></li><li><a href="Robot.html">Robot</a></li><li><a href="Shell.html">Shell</a></li><li><a href="TextMessage.html">TextMessage</a></li><li><a href="TopicMessage.html">TopicMessage</a></li></ul><h3>Global</h3><ul><li><a href="global.html#create">create</a></li><li><a href="global.html#loadHistory">loadHistory</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Wed Nov 17 2021 01:27:40 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
